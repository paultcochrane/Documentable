<!doctype html>
<html lang="en">
<head>
    <title>class Lock</title>
    <meta charset="UTF-8"/>
    <meta name=viewport content="width=device-width, initial-scale=1">
    <link rel="icon" href="/Documentable/integration-test/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="/Documentable/integration-test/css/app.css" media="screen" title="default" />
    <noscript> <style> #search { visibility: hidden; } </style> </noscript>
</head>

<body class="pod">

    <div id="___top"></div>

    <div id="header" class="pretty-box green">

        <a href="/Documentable/integration-test/">
            <img src="/Documentable/integration-test/images/Camelia.svg"alt="»ö«"id="logo"width="62"height="48"/> &nbsp;Raku Documentation
        </a>

        <div id="search" class="ui-widget">
            <div class="green">
                <input placeholder="Loading..." id="query" accesskey="f" title="Enter term to search for (hit Esc to focus)"/>
            </div>
            <p id="not-found-message">
                Not in Index (<a href="" id="try-web-search">try site search</a>)
            </p>
        </div>
        
        <div class="menu">
            
            <div class="menu-items dark-green">
                <a class='menu-item darker-green' href='https://raku.org'><strong>Raku homepage</strong></a>
                    <a class="menu-item " href="/Documentable/integration-test/language.html"> Language </a>
                    <a class="menu-item selected darker-green" href="/Documentable/integration-test/type.html"> Types </a>
                    <a class="menu-item " href="/Documentable/integration-test/routine.html"> Routines </a>
                    <a class="menu-item " href="https://webchat.freenode.net/?channels=#raku"> Chat with us </a>
            </div>
            
            <div class="menu-items darker-green"><div class="menu-items darker-green"><div class="menu-items darker-green"><div class="menu-items darker-green">
                    <a class="menu-item" href="/Documentable/integration-test/type.html"> All </a>
                    <a class="menu-item" href="/Documentable/integration-test/type-basic.html"> Basic </a>
                    <a class="menu-item" href="/Documentable/integration-test/type-html-generation.html"> HTML Generation </a>
                    <a class="menu-item" href="/Documentable/integration-test/type-exception.html"> Exceptions </a>
            </div></div></div></div>
        
        </div>
    </div>

    <div id="content" class="pretty-box yellow content_fragment">

        <div align="right" style="display:;">
            <button title="Edit this page"  class="pencil" onclick="location='https://github.com/Raku/doc/tree/master/docs/Type/Lock.pod6'">
                <svg width="14px" height="16px" viewBox="0 0 14 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <defs></defs>
                    <g id="Octicons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <g id="pencil" fill="#000000">
                            <path d="M0,12 L0,15 L3,15 L11,7 L8,4 L0,12 L0,12 Z M3,14 L1,14 L1,12 L2,12 L2,13 L3,13 L3,14 L3,14 Z M13.3,4.7 L12,6 L9,3 L10.3,1.7 C10.69,1.31 11.32,1.31 11.71,1.7 L13.3,3.29 C13.69,3.68 13.69,4.31 13.3,4.7 L13.3,4.7 Z" id="Shape"></path>
                        </g>
                    </g>
                </svg>
            </button>
        </div>

        <h1 class="title">class Lock</h1>
        <p class="subtitle">A low-level, re-entrant, mutual exclusion lock</p>

        <nav class="indexgroup">
<table id="TOC">
<caption><h2 id="TOC_Title">Table of Contents</h2></caption>
                                                           <tr class="toc-level-1"><td class="toc-number">1</td><td class="toc-text"><a href="#Methods">Methods</a></td></tr>
 <tr class="toc-level-2"><td class="toc-number">1.1</td><td class="toc-text"><a href="#method_protect">method protect</a></td></tr>
                      <tr class="toc-level-2"><td class="toc-number">1.2</td><td class="toc-text"><a href="#method_lock">method lock</a></td></tr>
                       <tr class="toc-level-2"><td class="toc-number">1.3</td><td class="toc-text"><a href="#method_unlock">method unlock</a></td></tr>
                 <tr class="toc-level-2"><td class="toc-number">1.4</td><td class="toc-text"><a href="#method_condition">method condition</a></td></tr>
                     <tr class="toc-level-1"><td class="toc-number">2</td><td class="toc-text"><a href="#Type_Graph">Type Graph</a></td></tr>
 
</table>
</nav>

        <div class="pod-body ">
            <pre class="pod-block-code">class Lock {}</pre>
<p>A <code>Lock</code> is a low-level concurrency control construct. It provides mutual exclusion, meaning that only one thread may hold the lock at a time. Once the lock is unlocked, another thread may then lock it.</p>
<p>A <code>Lock</code> is typically used to protect access to one or more pieces of state. For example, in this program:</p>
<pre class="pod-block-code">my $x = 0;
my $l = Lock.new;
await (^10).map: {
    start {
        $l.protect({ $x++ });
    }
}
say $x;         # OUTPUT: «10␤»</pre>
<p>The <code>Lock</code> is used to protect operations on <code>$x</code>. An increment is not an atomic operation; without the lock, it would be possible for two threads to both read the number 5 and then both store back the number 6, thus losing an update. With the use of the <code>Lock</code>, only one thread may be running the increment at a time.</p>
<p>A <code>Lock</code> is re-entrant, meaning that a thread that holds the lock can lock it again without blocking. That thread must unlock the same number of times before the lock can be obtained by another thread (it works by keeping a recursion count).</p>
<p>It&#39;s important to understand that there is no direct connection between a <code>Lock</code> and any particular piece of data; it is up to the programmer to ensure that the <code>Lock</code> is held during all operations that involve the data in question. The <code>OO::Monitors</code> module, while not a complete solution to this problem, does provide a way to avoid dealing with the lock explicitly and encourage a more structured approach.</p>
<p>The <code>Lock</code> class is backed by operating-system provided constructs, and so a thread that is waiting to acquire a lock is, from the point of view of the operating system, blocked.</p>
<p>Code using high-level Raku concurrency constructs should avoid using <code>Lock</code>. Waiting to acquire a <code>Lock</code> blocks a real <code>Thread</code>, meaning that the thread pool (used by numerous higher-level Raku concurrency mechanisms) cannot use that thread in the meantime for anything else.</p>
<p>Any <code>await</code> performed while a <code>Lock</code> is held will behave in a blocking manner; the standard non-blocking behavior of <code>await</code> relies on the code following the `await` resuming on a different <code>Thread</code> from the pool, which is incompatible with the requirement that a <code>Lock</code> be unlocked by the same thread that locked it. See <a href="/Documentable/integration-test/type/Lock::Async">Lock::Async</a> for an alternative mechanism that does not have this shortcoming.</p>
<p>By their nature, <code>Lock</code>s are not composable, and it is possible to end up with hangs should circular dependencies on locks occur. Prefer to structure concurrent programs such that they communicate results rather than modify shared data structures, using mechanisms like <a href="/Documentable/integration-test/type/Promise">Promise</a>, <a href="/Documentable/integration-test/type/Channel">Channel</a> and <a href="/Documentable/integration-test/type/Supply">Supply</a>.</p>
<h1 id="Methods"><a class="u" href="#___top" title="go to top of document">Methods</a></h1>
<h2 id="method_protect"><a class="u" href="#___top" title="go to top of document">method protect</a></h2>
<p>Defined as:</p>
<pre class="pod-block-code">method protect(Lock:D: &amp;code)</pre>
<p>Obtains the lock, runs <code>&amp;code</code>, and releases the lock afterwards. Care is taken to make sure the lock is released even if the code is left through an exception.</p>
<p>Note that the <a href="/Documentable/integration-test/type/Lock">Lock</a> itself needs to be created outside the portion of the code that gets threaded and it needs to protect. In the first example below, <a href="/Documentable/integration-test/type/Lock">Lock</a> is first created and assigned to <code>$lock</code>, which is then used <em>inside</em> the <a href="/Documentable/integration-test/type/Promise">Promises</a> to protect the sensitive code. In the second example, a mistake is made: the <code>Lock</code> is created right inside the <a href="/Documentable/integration-test/type/Promise">Promise</a>, so the code ends up with a bunch of separate locks, created in a bunch of threads, and thus they don&#39;t actually protect the code we want to protect.</p>
<pre class="pod-block-code"># Right: $lock is instantiated outside the portion of the
# code that will get threaded and be in need of protection
my $lock = Lock.new;
await ^20 .map: {
    start {
        $lock.protect: {
            print &quot;Foo&quot;;
            sleep rand;
            say &quot;Bar&quot;;
        }
    }
}

# !!! WRONG !!! Lock is created inside threaded area!
await ^20 .map: {
    start {
        Lock.new.protect: {
            print &quot;Foo&quot;; sleep rand; say &quot;Bar&quot;;
        }
    }
}</pre>
<h2 id="method_lock"><a class="u" href="#___top" title="go to top of document">method lock</a></h2>
<p>Defined as:</p>
<pre class="pod-block-code">method lock(Lock:D:)</pre>
<p>Acquires the lock. If it is currently not available, waits for it.</p>
<pre class="pod-block-code">my $l = Lock.new;
$l.lock;</pre>
<p>Since a <code>Lock</code> is implemented using OS-provided facilities, a thread waiting for the lock will not be scheduled until the lock is available for it. Since <code>Lock</code> is re-entrant, if the current thread already holds the lock, calling <code>lock</code> will simply bump a recursion count.</p>
<p>While it&#39;s easy enough to use the <code>lock</code> method, it&#39;s more difficult to correctly use <a href="/Documentable/integration-test/type/Lock#method_unlock"><code>unlock</code></a>. Instead, prefer to use the <a href="/Documentable/integration-test/type/Lock#method_protect"><code>protect</code></a> method instead, which takes care of making sure the <code>lock</code>/<code>unlock</code> calls always both occur.</p>
<h2 id="method_unlock"><a class="u" href="#___top" title="go to top of document">method unlock</a></h2>
<p>Defined as:</p>
<pre class="pod-block-code">method unlock(Lock:D:)</pre>
<p>Releases the lock.</p>
<pre class="pod-block-code">my $l = Lock.new;
$l.lock;
$l.unlock;</pre>
<p>It is important to make sure the <code>Lock</code> is always released, even if an exception is thrown. The safest way to ensure this is to use the <a href="/Documentable/integration-test/type/Lock#method_protect"><code>protect</code></a> method, instead of explicitly calling <code>lock</code> and <code>unlock</code>. Failing that, use a <code>LEAVE</code> phaser.</p>
<pre class="pod-block-code">my $l = Lock.new;
{
    $l.lock;
    LEAVE $l.unlock;
}</pre>
<h2 id="method_condition"><a class="u" href="#___top" title="go to top of document">method condition</a></h2>
<p>Defined as:</p>
<pre class="pod-block-code">my class ConditionVariable {
    method wait();
    method signal();
    method signal_all();
}

method condition(Lock:D: --&gt; ConditionVariable:D)
</pre>
<p>Returns a condition variable. Compare <a href="https://web.stanford.edu/~ouster/cgi-bin/cs140-spring14/lecture.php?topic=locks">https://web.stanford.edu/~ouster/cgi-bin/cs140-spring14/lecture.php?topic=locks</a> or <a href="https://en.wikipedia.org/wiki/Monitor_%28synchronization%29">https://en.wikipedia.org/wiki/Monitor_%28synchronization%29</a> for background.</p>
<pre class="pod-block-code">my $l = Lock.new;
$l.condition;</pre>
<h1 id="Type_Graph"><a class="u" href="#___top" title="go to top of document">Type Graph</a></h1>
<figure>
  <figcaption>Type relations for <code>Lock</code></figcaption>
  <svg width="69pt" height="188pt"
 viewBox="0.00 0.00 69.09 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<title>perl6&#45;type&#45;graph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-184 65.09,-184 65.09,4 -4,4"/>
<!-- Lock -->
<g id="node1" class="node">
<title>Lock</title>
<g id="a_node1"><a xlink:href="/type/Lock" xlink:title="Lock">
<ellipse fill="none" stroke="#000000" cx="30.55" cy="-18" rx="30.59" ry="18"/>
<text text-anchor="middle" x="30.55" y="-14.3" font-family="FreeSans" font-size="14.00" fill="#000000">Lock</text>
</a>
</g>
</g>
<!-- Any -->
<g id="node3" class="node">
<title>Any</title>
<g id="a_node3"><a xlink:href="/type/Any" xlink:title="Any">
<ellipse fill="none" stroke="#000000" cx="30.55" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="30.55" y="-86.3" font-family="FreeSans" font-size="14.00" fill="#000000">Any</text>
</a>
</g>
</g>
<!-- Lock&#45;&gt;Any -->
<g id="edge1" class="edge">
<title>Lock&#45;&gt;Any</title>
<path fill="none" stroke="#000000" d="M30.55,-36.3C30.55,-44.02 30.55,-53.29 30.55,-61.89"/>
<polygon fill="#000000" stroke="#000000" points="27.05,-61.9 30.55,-71.9 34.05,-61.9 27.05,-61.9"/>
</g>
<!-- Mu -->
<g id="node2" class="node">
<title>Mu</title>
<g id="a_node2"><a xlink:href="/type/Mu" xlink:title="Mu">
<ellipse fill="none" stroke="#000000" cx="30.55" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="30.55" y="-158.3" font-family="FreeSans" font-size="14.00" fill="#000000">Mu</text>
</a>
</g>
</g>
<!-- Any&#45;&gt;Mu -->
<g id="edge2" class="edge">
<title>Any&#45;&gt;Mu</title>
<path fill="none" stroke="#000000" d="M30.55,-108.3C30.55,-116.02 30.55,-125.29 30.55,-133.89"/>
<polygon fill="#000000" stroke="#000000" points="27.05,-133.9 30.55,-143.9 34.05,-133.9 27.05,-133.9"/>
</g>
</g>
</svg>

  <p class="fallback">
    <a
      rel="alternate"
      href="/images/type-graph-Lock.svg"
      type="image/svg+xml"
      >Expand above chart</a
    >
  </p>
</figure>

        </div>
    </div>

    

    <footer class="pretty-box yellow">
        <p>
            Generated from <a href="https://github.com/Raku/doc/tree/master/docs/Type/Lock.pod6">https://github.com/Raku/doc/tree/master/docs/Type/Lock.pod6</a>.
        </p>
        <p>
            This is a work in progress to document Raku (formerly known as Perl 6), and
            known to be incomplete.
        </p>
        <p>
            <a href="https://github.com/raku/doc/blob/master/CONTRIBUTING.md#reporting-bugs">
                Please report any issues
            </a>
            Your contribution is appreciated.
        </p>
        <p>
            This documentation is provided under the terms of the
            <a href="https://raw.githubusercontent.com/raku/doc/master/LICENSE">
                Artistic License 2.0
            </a>. The Camelia image is
            <a href="https://raw.githubusercontent.com/raku/mu/master/misc/camelia.txt">
                copyright © 2009 by Larry Wall.
            </a>
            <!-- CREDITS -->
            <!--External Link Image by Zapyon, CCA-SA 4.0. Derived from Wikimedia Foundation https://commons.wikimedia.org/wiki/File:External-link-04-bold-12x12.svg -->
        </p>
    </footer>

    <script type="text/javascript" src="/Documentable/integration-test/js/app.js?v=1"></script>
    <script type="text/javascript" src="/Documentable/integration-test/js/search.js?v=3"></script>
</body>
</html>

